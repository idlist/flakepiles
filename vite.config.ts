import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import banner from 'vite-plugin-banner'
import { viteStaticCopy as copy, Target } from 'vite-plugin-static-copy'
import { fileURLToPath } from 'node:url'
import { builtinModules } from 'node:module'

const external: string[] = [
  'obsidian',
  'electron',
  '@codemirror/autocomplete',
  '@codemirror/collab',
  '@codemirror/commands',
  '@codemirror/language',
  '@codemirror/lint',
  '@codemirror/search',
  '@codemirror/state',
  '@codemirror/view',
  '@lezer/common',
  '@lezer/highlight',
  '@lezer/lr',
  ...builtinModules
]

const content: string = `/*!
THIS IS A GENERATED/BUNDLED FILE BY VITE
Please visit the github repository of this plugin for the source file:
https://github.com/idlist/flakepiles
*/`

const files = ['main.js', 'styles.css', 'manifest.json']

const copyTargets = () => {
  const targets: Target[] = []

  for (const file of files) {
    targets.push({ src: file, dest: 'dist' })
  }

  return targets
}

export default defineConfig(({ mode }) => {
  const prod = mode == 'production'

  const define = {}
  if (prod) {
    define['process.env.NODE_ENV'] = '"production"'
  }

  return {
    plugins: [
      vue(),
      banner(content),
      copy({ targets: prod ? copyTargets() : [] })
    ],
    define,
    resolve: {
      alias: {
        '@': fileURLToPath(new URL('./src', import.meta.url)),
      },
    },
    build: {
      target: 'es2018',
      outDir: '.',
      emptyOutDir: false,
      sourcemap: prod ? false : 'inline',
      rollupOptions: {
        external,
      },
      lib: {
        entry: 'src/main.ts',
        fileName: () => 'main.js',
        formats: ['cjs'],
        cssFileName: 'styles'
      },
      minify: prod,
    },
  }
})
